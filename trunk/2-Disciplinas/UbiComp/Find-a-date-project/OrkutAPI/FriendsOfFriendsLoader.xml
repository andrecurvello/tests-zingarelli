<?xml version="1.0" encoding="UTF-8"?>
<Module>
	<ModulePrefs title="Load info of friends of friends" description="This is an app for testing fetching my friends data" author="Matheus Ricardo Uihara Zingarelli">
		<Require feature="opensocial-0.8"/>
		<Require feature="dynamic-height" />
	</ModulePrefs>
	<Content type="html">
		<![CDATA[
			<script type="text/javascript">
				function loadFriends() {
					var req = opensocial.newDataRequest();
					
					//use this to fetch data for a single person ID, the viewer on this case
					//the 'viewer' is a key to access all data fetched for the person ID (viewer)
					req.add(req.newFetchPersonRequest(opensocial.IdSpec.PersonId.VIEWER), 'viewer');

					//get friends of the current user
					var viewerFriends = opensocial.newIdSpec({ "userId" : "VIEWER", "groupId" : "FRIENDS" });
					//set a maximum of data to be fetched and get profile Thumbnail
					var opt_params = {};
					opt_params[opensocial.DataRequest.PeopleRequestFields.MAX] = 1000;
				    req.add(req.newFetchPeopleRequest(viewerFriends, opt_params), 'viewerFriends');

					//onLoadFriends is a callback for the javascript function of the same name
					req.send(onLoadFriends);
				}

				//data on this case is what was fetched from loadFriends
				function onLoadFriends(data) {
					
					//verify if any error occurred
					if(data.get('viewer').hadError()){
						alert(data.get('viewer').getErrorCode());
					}else if(data.get('viewerFriends').hadError()){
						alert(data.get('viewerFriends').getErrorCode());
					}else{
					
						//get data
						var viewer = data.get('viewer').getData();
						var viewerFriends = data.get('viewerFriends').getData();
						
						html = new Array();
						html.push('<ul>');
						viewerFriends.each(function(person) {
							if (person.getId()) {
								//get the friend social ID
								var friendID = person.getId();
								html.push('<li>', friendID, '</li>');
								//load the friends of friend (only the ones with the app installed will be sucessful)
								loadFriendsOfFriends(friendID);
							}
						});
						html.push('</ul>');
						document.getElementById('friends').innerHTML = html.join('');
						gadgets.window.adjustHeight();
					}
				}
				
				//load Friends of Friends data given the user social ids
				function loadFriendsOfFriends(friendID){
					var req = opensocial.newDataRequest();

					//get friends of friendID
					var friendOfFriends = opensocial.newIdSpec({ "userId" : friendID, "groupId" : "FRIENDS" });
					//set a maximum of data to be fetched and get profile Thumbnail
					var opt_params = {};
					opt_params[opensocial.DataRequest.PeopleRequestFields.MAX] = 1000;
				    req.add(req.newFetchPeopleRequest(friendOfFriends, opt_params), 'friendOfFriends');

					//onLoadFriends is a callback for the javascript function of the same name
					req.send(onLoadFriendsofFriends);	
				}
				
				//get data fetched by loadFriendsOfFriends
				function onLoadFriendsofFriends(data){
					//verify if any error occurred
					if(data.get('friendOfFriends').hadError()){
						alert(data.get('friendOfFriends').getErrorCode());
					}else{					
						//get data
						var friendOfFriends = data.get('friendOfFriends').getData();
						
						html = new Array();
						html.push('<ul>');
						friendOfFriends.each(function(person) {
							if (person.getId()) {
								//load person profile
								html.push('<li>', person.getField(opensocial.Person.Field.RELATIONSHIP_STATUS), '</li>');
							}
						});
						html.push('</ul>');
						document.getElementById('friends').innerHTML = html.join('');
						gadgets.window.adjustHeight();
					}
				}

				function init() {
					loadFriends();
				}

				gadgets.util.registerOnLoadHandler(init);
			</script>
			<div id='main'>
				Your friends:
				<div id='friends'></div>
			</div>
		]]>
	</Content>
</Module>